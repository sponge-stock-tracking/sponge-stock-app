# Supabase PostgreSQL Setup Guide

## üêò Supabase Database Configuration

### 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Sign up/Login with GitHub
3. Create New Project:
   - **Name:** sponge-stock-db
   - **Database Password:** (Generate strong password)
   - **Region:** Europe (Central EU) - closest to you
   - **Pricing Plan:** Free tier

### 2. Get Database Connection String

1. Go to **Project Settings** (‚öôÔ∏è icon)
2. Navigate to **Database** section
3. Scroll to **Connection string**
4. Select **URI** tab
5. Copy the connection string (it looks like):

```
postgresql://postgres.[PROJECT-REF]:[YOUR-PASSWORD]@aws-0-eu-central-1.pooler.supabase.com:6543/postgres
```

**Important:** Replace `[YOUR-PASSWORD]` with the actual password you set during project creation!

### 3. Connection Pooler vs Direct Connection

Supabase provides two connection methods:

#### üîπ Connection Pooler (Recommended for Serverless)

```
Host: aws-0-[region].pooler.supabase.com
Port: 6543
Mode: Transaction
```

**Use for:** Render, Vercel, Lambda, serverless environments

#### üîπ Direct Connection

```
Host: db.[project-ref].supabase.co
Port: 5432
Mode: Session
```

**Use for:** Long-running servers, migrations

### 4. Example Connection Strings

**For Render Backend (Use Pooler):**

```
postgresql://postgres.abcdefghijklmnop:your-password@aws-0-eu-central-1.pooler.supabase.com:6543/postgres
```

**For Local Migrations (Use Direct):**

```
postgresql://postgres.abcdefghijklmnop:your-password@db.abcdefghijklmnop.supabase.co:5432/postgres
```

---

## üîß Configure Backend on Render

### Environment Variables in Render Dashboard:

```bash
DATABASE_URL=postgresql://postgres.[YOUR-PROJECT-REF]:[PASSWORD]@aws-0-eu-central-1.pooler.supabase.com:6543/postgres
SECRET_KEY=<auto-generated by Render>
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
APP_NAME=Sponge Stock API
APP_ENV=production
LOG_LEVEL=INFO
PYTHONUNBUFFERED=1
CORS_ORIGINS=https://sponge-stock-app.vercel.app,http://localhost:3000
```

---

## üöÄ Run Database Migrations

### Option 1: From Local Machine

```bash
# Set environment variable
export DATABASE_URL="postgresql://postgres.[REF]:[PASSWORD]@db.[REF].supabase.co:5432/postgres"

# Run migrations
cd backend
alembic upgrade head
```

### Option 2: From Render Shell

1. Go to your Render service
2. Click **Shell** tab
3. Run:

```bash
alembic upgrade head
```

---

## üîê Security Settings in Supabase

### 1. Enable Connection Pooling

Already enabled by default ‚úÖ

### 2. Configure IP Restrictions (Optional)

In Supabase Dashboard:

- Settings ‚Üí Database ‚Üí Connection Pooling
- Add Render IP ranges if needed (usually not required)

### 3. SSL Mode

Supabase enforces SSL by default ‚úÖ

---

## üìä Database Management

### Supabase Dashboard Features:

1. **Table Editor** - View/Edit data visually
2. **SQL Editor** - Run custom queries
3. **Database** - Manage schemas, triggers, functions
4. **API** - Auto-generated REST & GraphQL APIs (optional)
5. **Logs** - Query performance monitoring

---

## üß™ Test Connection

### From Backend Shell (Render):

```bash
python -c "from app.core.database import engine; print(engine.connect())"
```

Expected output: `<Connection object>`

### From Local:

```bash
cd backend
python -c "from app.core.database import engine; engine.connect(); print('‚úÖ Connection successful!')"
```

---

## üìù Database Schema

Your Alembic migrations will create these tables:

- `users` - User accounts
- `sponges` - Sponge types
- `stocks` - Stock movements
- `reports` - Generated reports
- `notifications` - User notifications
- `refresh_tokens` - JWT refresh tokens

---

## üí° Supabase Free Tier Limits

‚úÖ **Included in Free Tier:**

- 500 MB database space
- 1 GB file storage
- 2 GB bandwidth/month
- Unlimited API requests
- 50,000 monthly active users
- 7 days log retention

**Perfect for your project!** üéâ

---

## üêõ Troubleshooting

### Connection Refused

- ‚úÖ Check password is correct
- ‚úÖ Use **pooler** URL for Render
- ‚úÖ Verify project is not paused

### SSL Required Error

Add `?sslmode=require` to connection string:

```
postgresql://...postgres?sslmode=require
```

### Too Many Connections

- Switch to **connection pooler** URL (port 6543)
- Use transaction mode

### Migrations Fail

- Use **direct connection** for migrations (port 5432)
- Check if tables already exist

---

## üîÑ Backup & Restore

### Automatic Backups

Supabase free tier includes:

- Daily backups (7 days retention)
- Point-in-time recovery

### Manual Backup

```bash
pg_dump "postgresql://postgres.[REF]:[PASSWORD]@db.[REF].supabase.co:5432/postgres" > backup.sql
```

### Restore

```bash
psql "postgresql://postgres.[REF]:[PASSWORD]@db.[REF].supabase.co:5432/postgres" < backup.sql
```

---

## üìã Deployment Checklist

- [ ] Supabase project created
- [ ] Database password saved securely
- [ ] Connection string (pooler) copied
- [ ] Added DATABASE_URL to Render
- [ ] Migrations run successfully
- [ ] Test connection works
- [ ] CORS_ORIGINS includes Vercel URL
- [ ] Backend deployed on Render
- [ ] Frontend deployed on Vercel
- [ ] End-to-end test successful

---

## üéØ Final Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Vercel         ‚îÇ
‚îÇ  (Frontend)     ‚îÇ
‚îÇ  Next.js        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTPS
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Render         ‚îÇ
‚îÇ  (Backend)      ‚îÇ
‚îÇ  FastAPI        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ PostgreSQL
         ‚îÇ Connection Pool
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase       ‚îÇ
‚îÇ  (Database)     ‚îÇ
‚îÇ  PostgreSQL     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**All FREE!** üéâ

---

## üÜò Support

- [Supabase Docs](https://supabase.com/docs)
- [Supabase Discord](https://discord.supabase.com)
- [GitHub Issues](https://github.com/sponge-stock-tracking/sponge-stock-app/issues)

Good luck! üöÄ
